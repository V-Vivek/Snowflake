# Unstructured Data Loading in Snowflake

## Create a Stage
To load unstructured data into Snowflake, you first need to create a stage. A stage is a location where data files are stored before being loaded into a table.

```sql
CREATE OR REPLACE STAGE my_stage
    URL='s3://my-bucket/path/'
    CREDENTIALS=(AWS_KEY_ID='your_aws_key_id' AWS_SECRET_KEY='your_aws_secret_key');
```

## Create a File Format Object
Next, create a file format object to specify the format of the data files.

```sql
CREATE OR REPLACE FILE FORMAT my_json_format
    TYPE = 'JSON';
```

## Create a Table to Store Raw Data with VARIANT Datatype
Create a table to store the raw data. Use the `VARIANT` datatype to store semi-structured or unstructured data.

```sql
CREATE OR REPLACE TABLE raw_data_table (
    raw VARIANT
);
```

## Copy the Data from Stage to the Raw Table
Finally, copy the data from the stage to the raw table.

```sql
COPY INTO raw_data_table
    FROM @my_stage
    FILE_FORMAT = (FORMAT_NAME = 'my_json_format');
```

## Sample JSON Example

```json
{
    "id": 1,
    "name": "John Doe",
    "email": "john.doe@example.com",
    "roles": ["admin", "user"],
    "profile": {
        "age": 30,
        "address": {
            "street": "123 Main St",
            "city": "Anytown",
            "zipcode": "12345"
        }
    },
    "orders": [
        {
            "order_id": 101,
            "product": "Laptop",
            "quantity": 1,
            "price": 999.99
        },
        {
            "order_id": 102,
            "product": "Mouse",
            "quantity": 2,
            "price": 19.99
        }
    ]
}
```

## Parsing JSON

### Handling plain data

```sql
SELECT 
    raw:id::INT AS id,
    raw:name::STRING AS name,
    raw:email::STRING AS email
FROM raw_data_table;
```

### Handling nested data
To access the object with the main JSON

```sql
-- Using .
SELECT 
    raw:name::STRING AS name,
    raw:profile.age::INT AS age,
    raw:profile.address.city::STRING AS city,
    raw:profile.address.zipcode::STRING AS zipcode
FROM raw_data_table;
```

### Using FLATTEN
To access the object inside the array

```sql
SELECT 
-- Here value is a keyword and not a column name
    o.value:order_id::INT AS order_id, 
    o.value:price::FLOAT AS price
FROM raw_data_table, TABLE(FLATTEN(raw:orders)) AS o;
```

## Create a Final Table and Insert Data

Create a final table to store the parsed data.

```sql
CREATE OR REPLACE TABLE final_data_table (
    id INT,
    name STRING,
    email STRING,
    age INT,
    city STRING,
    zipcode STRING,
    order_id INT,
    price FLOAT
);
```

Insert the parsed data into the final table.

```sql
INSERT INTO final_data_table
SELECT 
    raw:id::INT AS id,
    raw:name::STRING AS name,
    raw:email::STRING AS email,
    raw:profile.age::INT AS age,
    raw:profile.address.city::STRING AS city,
    raw:profile.address.zipcode::STRING AS zipcode,
    o.value:order_id::INT AS order_id, 
    o.value:price::FLOAT AS price
FROM raw_data_table, TABLE(FLATTEN(raw:orders)) AS o;
```