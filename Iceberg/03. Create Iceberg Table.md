# Creating an Iceberg Table in Snowflake

## Step 1: Create an External Volume in GCP

To create an external volume in Google Cloud Platform (GCP), follow these steps:

1. **Create a GCP Bucket**:
    - Go to the GCP Console.
    - Navigate to the "Cloud Storage" section.
    - Click on "Create Bucket".
    - Provide a unique name for your bucket and configure the necessary settings.
    - Click "Create".

2. **Create an External Volume in Snowflake**:
    - To create an external volume in Snowflake, use the following SQL commands:

        ```sql
        CREATE EXTERNAL VOLUME my_gcs_external_volume
        STORAGE_LOCATIONS =
        (
            (
                NAME = 'my-us-west-2'
                STORAGE_PROVIDER = 'GCS'
                STORAGE_BASE_URL = 'gcs://mybucket1/path1/'
                ENCRYPTION = 
                (
                    TYPE='GCS_SSE_KMS'
                    KMS_KEY_ID = '1234abcd-12ab-34cd-56ef-1234567890ab'
                )
            )
        );
        ```

5. **Retrieve the GCS service account**:
    - Record the value of the STORAGE_GCP_SERVICE_ACCOUNT property in the output
        ```sql
        DESC EXTERNAL VOLUME my_gcs_external_volume;
        ```
4. **Configure Access Permissions**:
    - Ensure that the Snowflake service account has the necessary permissions to access the GCP bucket.
    - You can grant permissions by adding the service account to the bucket's IAM policy with roles such as `Storage Object Viewer` and `Storage Object Admin`.

## Step 2: Create an Iceberg Table in Snowflake

To create an Iceberg table in Snowflake, use the following SQL commands:

```sql
CREATE OR REPLACE ICEBERG TABLE my_iceberg_table (
    id INT,
    name STRING,
    created_at TIMESTAMP
)
CATALOG = 'SNOWFLAKE'
EXTERNAL_VOLUME = 'my_gcs_external_volume'
BASE_LOCATION = '';  -- Keeping this balnk will use STORAGE_BASE_URL as the base location
```

## Step 3: Files Stored in the GCP Bucket

After creating the Iceberg table, the following types of files will be stored in the GCP bucket:

- A folder will be created with the table name
- That folder consists of 2 sub-folders
    - data
    - metadata

### Data folder contains:
1. **Data Files**: These files contain the actual data stored in the table. They are typically in Parquet format.

### Metadata folder contains:
1. **Metadata Files**: These files store metadata about the table, such as schema information, partitioning, and snapshots. They are typically in json format.

2. **Snapshot Files**: These files represent a consistent view of the table at a specific point in time. They are typically in Avro format.

3. **Manifest Files**: These files list the data files that belong to a specific snapshot. They are typically in Avro format.

These files are managed by the Iceberg table format to ensure efficient querying and data management.
