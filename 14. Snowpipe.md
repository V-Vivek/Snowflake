# Snowpipe

## What is Snowpipe?
Snowpipe is a continuous data ingestion service provided by Snowflake. It allows for the automated loading of data into Snowflake as soon as it becomes available in a specified stage. This service is designed to handle streaming data and ensures that data is available for querying with minimal latency. Snowpipe is a serverless service, meaning it does not require a virtual warehouse to store the pipe object. This allows for efficient and cost-effective data ingestion without the need for managing additional compute resources.

## Setting Up Snowpipe

To set up Snowpipe, follow these steps:

### 1. Create Integration Object

First, create an integration object to allow Snowflake to access your cloud storage.

```sql
CREATE STORAGE INTEGRATION my_integration
    TYPE = EXTERNAL_STAGE
    STORAGE_PROVIDER = 'GCS'
    ENABLED = TRUE
    STORAGE_GCP_SERVICE_ACCOUNT = '<your-gcp-service-account>'
    STORAGE_ALLOWED_LOCATIONS = ('gcs://your-bucket-name/');
```

### 2. Create Stage

Next, create a stage that references the integration object.

```sql
CREATE STAGE my_stage
    URL = 'gcs://your-bucket-name/'
    STORAGE_INTEGRATION = my_integration;
```

### 3. Create Pipe

Create a pipe to define the data loading process.

```sql
CREATE OR REPLACE PIPE my_pipe
    AUTO_INGEST = TRUE
    AS
    COPY INTO my_table
    FROM @my_stage
    FILE_FORMAT = (TYPE = 'CSV' FIELD_OPTIONALLY_ENCLOSED_BY = '"');
```

### 4. Setup Notification

Configure your cloud storage to send notifications to Snowflake when new data is available. This typically involves setting up an event notification service in your cloud provider (e.g., Google Cloud Pub/Sub for GCS).

### 5. Retrieve Notification Channel

Use the `DESC PIPE` command to retrieve the notification channel name for your pipe.

```sql
DESC PIPE my_pipe;
```

Look for the `NOTIFICATION_CHANNEL` value in the output. This is the name of the Pub/Sub topic that Snowflake will use to receive notifications.

### 6. Set Up Notification

Use the notification channel name to set up the notification in your cloud provider. For example, in GCP, you would subscribe the Snowflake notification channel to your GCS bucket events using the Pub/Sub topic name.

```sh
gcloud pubsub subscriptions create <your-subscription-name> --topic=<notification-channel-name>
```

Ensure that your GCS bucket is configured to send event notifications to the Pub/Sub topic for the required events (e.g., object creation).

## Error Handling

### Using `VALIDATE_PIPE_LOAD`

Use the `VALIDATE_PIPE_LOAD` function to validate the data load process.

```sql
SELECT * FROM TABLE(
    VALIDATE_PIPE_LOAD(
        pipe_name => 'my_pipe',
        start_time => '2023-01-01T00:00:00Z'
    )
);
```

This function checks the data load process for the specified pipe within the given time range and returns any errors or issues encountered.


### Using `INFORMATION_SCHEMA.COPY_HISTORY`

Query the `COPY_HISTORY` view to get information about past data loads.

```sql
SELECT *
FROM INFORMATION_SCHEMA.COPY_HISTORY
WHERE PIPE_NAME = 'my_pipe'
ORDER BY LAST_LOAD_TIME DESC;
```

## Pipe Management Commands

### DESC pipe

The `DESC PIPE` command provides detailed information about a specific pipe, including its definition, status, and notification channel.

```sql
DESC PIPE my_pipe;
```

### SHOW pipe
```sql
-- To list all pipes in the current or specified database/schema.
SHOW PIPES;

-- Tto filter pipes based on a pattern.
SHOW PIPES LIKE 'my_pipe%';

-- List all pipes in a specific database.
SHOW PIPES IN DATABASE my_database;

-- List all pipes in a specific schema.
SHOW PIPES IN SCHEMA my_schema;

-- Filter pipes based on a pattern within a specific database.
SHOW PIPES LIKE 'my_pipe%' IN DATABASE my_database;
```

### Refresh pipe

The command manually triggers the pipe to ingest data from the stage.

```sql
ALTER PIPE my_pipe REFRESH;
```

### Check pipe status

```sql
SELECT SYSTEM$PIPE_STATUS('my_pipe');
```

### Pause pipe

Pause the automatic data ingestion for a pipe.

```sql
ALTER PIPE my_pipe SET PIPE_EXECUTION_PAUSED = TRUE;
```

### Resume pipe

Resume the automatic data ingestion for a paused pipe.

```sql
ALTER PIPE my_pipe SET PIPE_EXECUTION_PAUSED = FALSE;
```