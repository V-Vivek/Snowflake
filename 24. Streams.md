# Snowflake Streams

A stream in Snowflake is a change tracking object that records changes made to a table. It does not store a copy of the data but instead references the data present in the table and updates its metadata accordingly.

## Metadata Columns
- **METADATA$ACTION**: Indicates the type of DML operation (INSERT & DELETE) performed on the table.
- **METADATA$ISUPDATE**: A boolean value indicating whether the row was updated.
- **METADATA$ROW_ID**: A unique identifier for the row in the table.

## Stream Syntax
- **CREATE**: 
```sql
CREATE STREAM stream_name 
ON TABLE table_name;
```
- **SHOW**: 
```sql
SHOW STREAMS;
```
- **DESC**: 
```sql
DESC STREAM stream_name;
```

## Staleness of a Stream
- A stream becomes stale when the underlying table is truncated or when the stream is not consumed for a long period. Staleness can be checked using the `SYSTEM$STREAM_HAS_DATA()` function.
- The default data retention period for a stream is 14 days. If data is not consumed from the stream within that time period the data will be lost and stream will again become empty.

## INSERT Operation Using Stream
```sql
INSERT INTO target_table
SELECT * FROM source_table_stream
WHERE METADATA$ACTION = 'INSERT' AND METADATA$ISUPDATE = 'FALSE';
```

## UPDATE Operation Using Stream
```sql
UPDATE target_table
SET column1 = source_table_stream.column1
FROM source_table_stream
WHERE target_table.id = source_table_stream.id
AND METADATA$ACTION = 'INSERT' AND METADATA$ISUPDATE = 'TRUE';
```

## DELETE Operation Using Stream
```sql
DELETE FROM target_table
USING source_table_stream
WHERE target_table.id = source_table_stream.id
AND METADATA$ACTION = 'DELETE' AND METADATA$ISUPDATE = 'FALSE';
```

## Simultaneous INSERT, UPDATE & DELETE Operation Using Stream
```sql
MERGE INTO target_table AS t
USING source_table_stream AS s
ON t.id = s.id
WHEN MATCHED AND s.METADATA$ACTION = 'DELETE' AND METADATA$ISUPDATE = 'FALSE' THEN DELETE
WHEN MATCHED AND s.METADATA$ACTION = 'INSERT' AND METADATA$ISUPDATE = 'TRUE' THEN UPDATE SET t.column1 = s.column1
WHEN NOT MATCHED AND s.METADATA$ACTION = 'INSERT' AND METADATA$ISUPDATE = 'FALSE' THEN INSERT (id, column1) VALUES (s.id, s.column1);
```

## Combining Streams and Tasks Using SYSTEM$STREAM_HAS_DATA()
Streams can be combined with tasks to automate data processing. The `SYSTEM$STREAM_HAS_DATA()` function can be used to check if a stream has data to process.

## Example of Using SYSTEM$STREAM_HAS_DATA() with Tasks

Here is an example of how to use `SYSTEM$STREAM_HAS_DATA()` in combination with tasks to automate data processing:

1. **Create a Task**: Create a task that runs a SQL statement to process data from the stream if there is data available.

```sql
CREATE OR REPLACE TASK process_stream_task
    WAREHOUSE = my_warehouse
    SCHEDULE = 'USING CRON 0 * * * * UTC'
    WHEN SYSTEM$STREAM_HAS_DATA('source_table_stream')
AS
    CALL my_stored_procedure();
```

2. **Enable the Task**: Enable the task to start the schedule.

```sql
ALTER TASK process_stream_task RESUME;
```

This setup ensures that the task will check for new data in the stream every hour and process it accordingly.

## APPEND_ONLY Streams
APPEND_ONLY streams track only insert operations and ignore updates and deletes. They are useful for scenarios where only new data needs to be processed.

```sql
CREATE STREAM append_only_stream 
ON TABLE table_name 
APPEND_ONLY = TRUE;
```
